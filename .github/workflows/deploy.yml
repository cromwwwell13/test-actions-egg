name: Deploy Angular App

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
    - name: SSH and Deploy Angular
      run: |
        ssh -o StrictHostKeyChecking=no egg13@192.168.10.20 << 'EOF'
          cd ~/angular_publicaciones

          # Actualizar cÃ³digo
          git fetch --all
          git reset --hard origin/master

          # 1. Construir la imagen (Sin el prefijo DOCKER_BUILDKIT)
          # Usamos el builder tradicional que es el que tienes activo
          docker build -t angular-app .

          # 2. Detener y borrar contenedor viejo
          # El || true evita que falle si el contenedor no existe
          docker rm -f angular-cont || true

          # 3. Lanzar el nuevo contenedor
          # El puerto 4200 mapeado al 80 del contenedor (Nginx)
          docker run -d \
            --name angular-cont \
            --net mis-servicios \
            -p 4200:80 \
            --restart always \
            angular-app
        EOF
